generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres", "postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [pg_trgm, uuid_ossp(map: "uuid-ossp", schema: "public")]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([provider])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expires])
}

model User {
  id                String    @id @default(cuid())
  name              String?
  email             String    @unique
  emailVerified     DateTime?
  image             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  fullName          String?
  phone             String?
  role              Role      @default(USER)
  isActive          Boolean   @default(true)
  lastLogin         DateTime?
  preferences       String    @default("{}")
  deletedAt         DateTime?
  accounts          Account[]
  bookings          Booking[]
  paymentsProcessed Payment[] @relation("ProcessedBy")
  sessions          Session[]

  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([createdAt])
  @@index([deletedAt])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Court {
  id              String    @id @default(cuid())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  name            String
  description     String?
  basePrice       Int
  priceMultiplier Float     @default(1.0)
  features        String
  isActive        Boolean   @default(true)
  operatingHours  String    @default("{\"start\": \"00:00\", \"end\": \"23:00\", \"slot_duration\": 90}")
  deletedAt       DateTime?
  bookings        Booking[]

  @@index([isActive])
  @@index([name])
  @@index([deletedAt])
}

model Booking {
  id                 String          @id @default(cuid())
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  courtId            String
  userId             String
  bookingDate        DateTime
  startTime          String
  endTime            String
  durationMinutes    Int             @default(90)
  totalPrice         Int
  depositAmount      Int             @default(0)
  status             BookingStatus   @default(PENDING)
  paymentStatus      PaymentStatus   @default(PENDING)
  paymentMethod      PaymentMethod?
  notes              String?
  cancelledAt        DateTime?
  cancellationReason String?
  deletedAt          DateTime?
  court              Court           @relation(fields: [courtId], references: [id])
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  players            BookingPlayer[]
  payments           Payment[]

  @@unique([courtId, bookingDate, startTime, endTime])
  @@index([courtId, bookingDate])
  @@index([userId, bookingDate])
  @@index([status, bookingDate])
  @@index([paymentStatus])
  @@index([bookingDate, startTime])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([courtId, status, bookingDate])
  // Índices adicionales para optimización
  @@index([courtId, bookingDate, status, paymentStatus], name: "idx_booking_complex_search")
  @@index([courtId, bookingDate, startTime, endTime], name: "idx_booking_time_range")
  @@index([status, paymentStatus, createdAt], name: "idx_booking_status_reports")
}

model BookingPlayer {
  id            String         @id @default(cuid())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  bookingId     String
  playerName    String
  playerPhone   String?
  playerEmail   String?
  hasPaid       Boolean        @default(false)
  paidAmount    Int            @default(0)
  paidAt        DateTime?
  paymentMethod PaymentMethod?
  position      Int?
  notes         String?
  deletedAt     DateTime?
  booking       Booking        @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  payments      Payment[]

  @@unique([bookingId, position])
  @@index([bookingId])
  @@index([hasPaid])
  @@index([playerEmail])
  @@index([deletedAt])
}

model Payment {
  id              String         @id @default(cuid())
  createdAt       DateTime       @default(now())
  bookingId       String
  playerId        String?
  processedById   String?
  amount          Int
  paymentMethod   PaymentMethod
  paymentType     PaymentType    @default(PAYMENT)
  referenceNumber String?
  notes           String?
  status          String         @default("completed")
  deletedAt       DateTime?
  updatedAt       DateTime       @updatedAt
  booking         Booking        @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  player          BookingPlayer? @relation(fields: [playerId], references: [id], onDelete: Cascade)
  processedBy     User?          @relation("ProcessedBy", fields: [processedById], references: [id])

  @@index([bookingId])
  @@index([playerId])
  @@index([processedById])
  @@index([paymentMethod])
  @@index([paymentType])
  @@index([status])
  @@index([createdAt])
  @@index([referenceNumber])
  @@index([deletedAt])
  // Índices adicionales para reportes y análisis
  @@index([createdAt, status, paymentMethod, amount], name: "idx_payment_reports")
  @@index([paymentMethod, paymentType, createdAt], name: "idx_payment_analytics")
}

model SystemSetting {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  key         String   @unique
  value       String
  description String?
  category    String   @default("general")
  isPublic    Boolean  @default(false)
}

model Producto {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  nombre    String
  precio    Float
  stock     Int      @default(0)
  categoria String
  activo    Boolean  @default(true)

  @@index([categoria])
  @@index([activo])
}

model AdminWhitelist {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  email     String   @unique
  isActive  Boolean  @default(true)
  addedBy   String?
  notes     String?

  @@index([email])
  @@index([isActive])
}

enum Role {
  USER
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  DEPOSIT_PAID
  FULLY_PAID
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CARD
}

enum PaymentType {
  PAYMENT
  REFUND
  ADJUSTMENT
}
